name: CI/CD for static site

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test:
    name: Test static files (HTML & links)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # HTML Lint
      - name: Lint HTML with html-proofer
        uses: anishathalye/html-proofer-action@v1
        with:
          # ルートをチェック（必要に応じて調整）
          directory: ./
          # 例: Jekyll無効なら _site は無いのでスキップ
          # 追加オプションは README を参照

      # Broken links
      - name: Check broken links with lychee
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose --no-progress
            --retry 2 --max-concurrency 5
            "./**/*.html" "./**/*.md"

  deploy:
    name: Build & Deploy (public/)
    needs: test
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare public directory (exclude non-public)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p public
          rsync -av --delete \
            --exclude 'backup/' \
            --exclude '_archives/' \
            --exclude 'dev/' \
            --exclude '.github/' \
            --exclude '.vscode/' \
            --exclude '.idea/' \
            --exclude '.DS_Store' \
            --exclude 'dist/' \
            --exclude 'node_modules/' \
            --exclude 'scripts/' \
            --exclude 'tests/' --exclude 'test/' --exclude '*.spec.*' --exclude '*.test.*' \
            --exclude 'content/**/*.json' \
            --exclude '*.psd' --exclude '*.ai' --exclude '*.aep' --exclude '*.sketch' --exclude '*.fig' \
            --exclude '*.wav' --exclude '*.aiff' \
            --exclude 'secrets/' --exclude '*.key' --exclude '*.pem' --exclude '*.p12' --exclude '.env*' \
            ./ public/

          # Disable Jekyll
          [ -f public/.nojekyll ] || { touch public/.nojekyll; echo "Created public/.nojekyll"; }

          # Fallback 404
          if [ ! -f public/404.html ]; then
            cat > public/404.html <<'HTML'
<!doctype html><meta charset="utf-8"><title>404</title>
<meta name="robots" content="noindex">
<p>404 Not Found</p><p><a href="./">Back to top</a></p>
HTML
            echo "Generated public/404.html (fallback)"
          fi

          # Warn when index.html is missing
          [ -f public/index.html ] || echo "::warning::public/index.html not found"

      - name: Upload artifact (public/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4