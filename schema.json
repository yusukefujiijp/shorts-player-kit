{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://shorts-player-kit/schema/v3.2.0",
  "title": "Shorts Script Schema v3.2.0 (AI-friendly, iOS-first)",
  "description": "停止級エラーのみをスキーマで遮断。Page3=Scripture／Page4=Prologue を任意フラグで強制可能。",

  "type": "object",
  "properties": {
    "//": { "type": "string" },
    "__contract__": { "type": "string" },

    "videoMeta": {
      "type": "object",
      "properties": {
        "dossierId": { "type": "string", "pattern": "^[A-Za-z0-9._-]+$" },
        "creationTimestamp": { "type": "string", "format": "date-time" },
        "theme": { "type": "string" },
        "triviaTitle": { "type": "string" },
        "thumbnailText": { "type": "string", "maxLength": 25 },
        "bannerText": { "type": "string", "maxLength": 20 },

        "meta": {
          "type": "object",
          "properties": {
            "tts": {
              "type": "object",
              "properties": {
                "filter": {
                  "type": "object",
                  "properties": { "jaOnly": { "type": "boolean", "default": true } },
                  "additionalProperties": false
                }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        },

        "tts": {
          "type": "object",
          "description": "後方互換（推奨は videoMeta.meta.tts）。",
          "properties": {
            "lang": { "type": "string" },
            "voicePreferences": { "type": "array", "items": { "type": "string" } },
            "rate": { "type": "number", "minimum": 0.5, "maximum": 2.0 },
            "filter": {
              "type": "object",
              "properties": { "jaOnly": { "type": "boolean", "default": true } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "ui": {
          "type": "object",
          "properties": {
            "a11y": {
              "type": "object",
              "properties": { "prefersReducedMotion": { "type": "boolean", "default": false } },
              "additionalProperties": false
            }
          },
          "additionalProperties": true
        },

        "contract": {
          "type": "object",
          "properties": {
            "structure": {
              "type": "object",
              "properties": {
                "requireOpeningEffect": { "type": "boolean", "default": true },
                "requireTransitionT": { "type": "boolean", "default": true },
                "requireClosingEffect": { "type": "boolean", "default": true },
                "minA": { "type": "integer", "minimum": 0, "default": 1 },
                "minB": { "type": "integer", "minimum": 0, "default": 1 },
                "scripturePrologueIntro": { "type": "boolean", "default": false }
              },
              "additionalProperties": false
            },
            "versionThemeMap": {
              "type": "object",
              "properties": {
                "A": { "type": "string", "enum": ["light","dark"], "default": "light" },
                "B": { "type": "string", "enum": ["light","dark"], "default": "dark" },
                "T": { "type": "string", "enum": ["light","dark"], "default": "dark" }
              },
              "additionalProperties": false
            },
            "bMandate": {
              "type": "object",
              "properties": {
                "role": { "type": "string", "enum": ["HolyOfHolies"] },
                "polemicAxis": { "type": "string", "enum": ["Hellenism_vs_Hebraism"] },
                "requireCovenantRelational": { "type": "boolean" }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        }
      },
      "required": ["dossierId","theme","thumbnailText"],
      "additionalProperties": true
    },

    "scenes": {
      "type": "array",
      "minItems": 1,
      "description": "先頭は必ず Play専用の placeholder。以降は content/effect。任意で Page3=Scripture, Page4=Prologue を強制可能。",
      "items": [
        {
          "allOf": [
            { "$ref": "#/$defs/placeholderScene" },
            { "properties": { "page": { "const": "1" } }, "required": ["page"] }
          ]
        }
      ],
      "additionalItems": { "oneOf": [ { "$ref": "#/$defs/contentScene" }, { "$ref": "#/$defs/effectScene" } ] }
    }
  },

  "required": ["videoMeta","scenes"],
  "additionalProperties": false,

  "allOf": [
    {
      "description": "opening が少なくとも1枚存在",
      "properties": {
        "scenes": { "type": "array", "contains": { "type": "object", "properties": { "type": { "const": "effect" }, "effectRole": { "const": "opening" } }, "required": ["type","effectRole"] } }
      }
    },
    {
      "description": "transition が少なくとも1枚存在",
      "properties": {
        "scenes": { "type": "array", "contains": { "type": "object", "properties": { "type": { "const": "effect" }, "effectRole": { "const": "transition" } }, "required": ["type","effectRole"] } }
      }
    },
    {
      "description": "closing が少なくとも1枚存在",
      "properties": {
        "scenes": { "type": "array", "contains": { "type": "object", "properties": { "type": { "const": "effect" }, "effectRole": { "const": "closing" } }, "required": ["type","effectRole"] } }
      }
    },
    {
      "description": "scripturePrologueIntro=true の時、items[2]=Page3 Scripture, items[3]=Page4 Prologue を強制",
      "if": {
        "properties": {
          "videoMeta": {
            "properties": {
              "contract": {
                "properties": {
                  "structure": {
                    "properties": { "scripturePrologueIntro": { "const": true } },
                    "required": ["scripturePrologueIntro"]
                  }
                },
                "required": ["structure"]
              }
            },
            "required": ["contract"]
          }
        },
        "required": ["videoMeta"]
      },
      "then": {
        "properties": {
          "scenes": {
            "items": [
              {},
              {},
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  { "properties": { "page": { "const": "3" }, "version": { "const": "A" }, "sectionTag": { "const": "#Scripture" } }, "required": ["page","version","sectionTag"] }
                ]
              },
              {
                "allOf": [
                  { "$ref": "#/$defs/contentScene" },
                  { "properties": { "page": { "const": "4" }, "version": { "const": "A" }, "sectionTag": { "const": "#Prologue" } }, "required": ["page","version","sectionTag"] }
                ]
              }
            ]
          }
        }
      }
    }
  ],

  "$defs": {
    "pageId": { "type": "string", "pattern": "^[1-9][0-9]*$" },
    "hexColor": { "type": "string", "pattern": "^#[0-9a-fA-F]{6}$" },

    "placeholderScene": {
      "type": "object",
      "description": "Page-1のPlay専用（画面文言なし）。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "placeholder" },
        "title": { "type": "string" }
      },
      "required": ["page","type"],
      "additionalProperties": false
    },

    "contentScene": {
      "type": "object",
      "description": "本文を持つ通常シーン（A/B/T）。type:'content' を明示。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "content" },
        "version": { "type": "string", "enum": ["A","B","T"] },
        "sectionTag": { "type": "string" },

        "title_key": { "type": "string", "pattern": "^\\u3010.+\\u3011$", "minLength": 2, "maxLength": 20 },
        "title": { "type": "string", "minLength": 1, "maxLength": 28 },
        "symbol": { "type": "string", "minLength": 1, "maxLength": 16 },
        "base": { "$ref": "#/$defs/hexColor" },
        "narr": { "type": "string", "maxLength": 280 },

        "effect": { "type": "string", "enum": ["light-in","fade-in","slide-up","zoom-in"] },
        "durationHintMs": { "type": "integer", "minimum": 0 },

        "titleKeyReadAloud": { "type": "boolean", "default": false },

        "sanctum": { "type": "string", "enum": ["outer","holy","holy_of_holies"] },
        "polemicAxis": { "type": "string", "enum": ["Hellenism_vs_Hebraism"] },
        "doctrineTags": {
          "type": "array",
          "items": { "type": "string", "enum": ["HolyOfHolies","DepartureFromHellenism","CovenantCentered","IdolatryDenunciation","SpiritLedTransformation"] },
          "uniqueItems": true
        }
      },
      "required": ["page","type","version","title_key","title","symbol","base","narr"],
      "additionalProperties": false,

      "allOf": [
        {
          "description": "Aは #Trivia1..#Trivia7 または #Scripture/#Prologue を必須（導入パターン対応）",
          "if": { "properties": { "version": { "const": "A" } }, "required": ["version"] },
          "then": {
            "required": ["sectionTag"],
            "properties": {
              "sectionTag": { "type": "string", "pattern": "^#(Trivia([1-7])|Scripture|Prologue)$" }
            }
          }
        },
        {
          "description": "Bは holy_of_holies + 反ヘレニズム + 教理タグ>=2 を必須",
          "if": { "properties": { "version": { "const": "B" } }, "required": ["version"] },
          "then": {
            "required": ["sanctum","polemicAxis","doctrineTags"],
            "properties": {
              "sanctum": { "const": "holy_of_holies" },
              "polemicAxis": { "const": "Hellenism_vs_Hebraism" },
              "doctrineTags": { "minItems": 2 }
            }
          }
        },
        {
          "description": "聖なるリズム（最低1改行）",
          "properties": { "narr": { "pattern": ".*\\n.*" } }
        },
        {
          "description": "長文>=80では段落推奨（\\n\\n を要求：緩い拘束）",
          "if": { "properties": { "narr": { "minLength": 80 } }, "required": ["narr"] },
          "then": { "properties": { "narr": { "pattern": ".*\\n\\n.*" } } }
        }
      ]
    },

    "effectScene": {
      "type": "object",
      "description": "純エフェクト。本文キーは禁止。時間キーは t|duration|durationMs|effectDuration のいずれでも可。",
      "properties": {
        "page": { "$ref": "#/$defs/pageId" },
        "type": { "type": "string", "const": "effect" },
        "effect": { "type": "string", "enum": ["light-in","fade-in","fade-to-black","flame-out","veil-sweep","slow-bloom"] },
        "effectRole": { "type": "string", "enum": ["opening","transition","closing"] },
        "uiVersion": { "type": "string", "enum": ["A","B","T"] },
        "base": { "$ref": "#/$defs/hexColor" },

        "t": { "type": "integer", "minimum": 0 },
        "duration": { "type": "integer", "minimum": 0 },
        "durationMs": { "type": "integer", "minimum": 0 },
        "effectDuration": { "type": "integer", "minimum": 0 }
      },
      "required": ["page","type","effect","base"],
      "additionalProperties": false,

      "allOf": [
        {
          "description": "本文キーは禁止",
          "not": {
            "anyOf": [
              { "required": ["title_key"] },
              { "required": ["title"] },
              { "required": ["symbol"] },
              { "required": ["narr"] },
              { "required": ["sectionTag"] }
            ]
          }
        }
      ]
    }
  }
}