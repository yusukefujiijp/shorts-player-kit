【🧰JSフォルダ運用規範: デバッグ機能ゲーティングと演出/TTSの完全実装ガイド】
	1.	目的（What & Why）
1.1 本READMEは、js/ フォルダの全体仕様・使い方・保守規範を一箇所に集約し、数日後でも即時復元できることを目的とします。
1.2 運用の最重要原則は、**ブロック毎のCopy&Paste（完全体）**です。単一一致アンカーを用いた貼付のみで改変を成立させ、人的エラーを最小化します。
	2.	構成（ファイル一覧）
2.1 global-zoom-guard.js
2.1.1 端末のズーム挙動・Safe Area等の環境保護を司る軽量ガード。
2.2 tts-voice-utils.js
2.2.1 Web Speech APIの声カタログ生成と選好設定を提供。
2.2.2 公開API: window.__ttsVoiceCatalog（配列）, window.__ttsUtils.setup(opts), window.__ttsUtils.pick(role), window.__ttsUtils.getCatalog().
2.3 scene-effects.js
2.3.1 Promise規約のエフェクト・レジストリ。標準 light-in / fade-in / slide-up / zoom-in / flame-out(burn-out) を搭載。
2.3.2 公開API: window.__effects.register(name, fn), window.__effects.run(name, el, opts), list(), has().
2.4 player.core.js
2.4.1 背景権威（scene.baseの適用）／再生制御／TTS読み上げ／__player APIのエクスポート。
2.5 debug_panel.js
2.5.1 折り畳みデバッグUI。Note / Prev / Next / Goto / Play / Stop / TTS flags / Voice map。
2.5.2 コード側フラグ（window.__dbgConfig）による機能ゲーティングに対応。
2.6 debug_config.js（新規・ユーザー編集用）
2.6.1 デバッグ機能の可視化設定を一元管理。UIからは変更できず、コード修正→リロードのみで反映。
	3.	読み込み順（厳守）
3.1 index.html への <script> 追加は以下の順序を厳守します。
3.2 完全体ブロック（Copy&Paste用：</body> 直前推奨）

<!-- 1) 必須: 視覚・演出エンジン -->
<script src="./js/scene-effects.js" defer></script>

<!-- 2) 必須: プレイヤ中枢（__playerを定義） -->
<script src="./js/player.core.js" defer></script>

<!-- 3) 新設: デバッグ設定（コード側での可視化制御） -->
<script src="./js/debug_config.js" defer></script>

<!-- 4) 必須: デバッグUI本体（↑設定を参照して初期化） -->
<script src="./js/debug_panel.js" defer></script>

3.3 依存関係の要点
3.3.1 debug_panel.js は __player に依存するため、player.core.js の後に読み込むこと。
3.3.2 debug_panel.js は window.__dbgConfig を参照するため、debug_config.js の後に読み込むこと。
	4.	安全運用規範（ヘッダー準拠・不変規約）
4.1 Page1 = Play Button Only。テキスト／エフェクト／TTS禁止（バグ防止）。
4.2 閉幕順序の不変規約: Epilogue（Bのテキスト）→ flame-out/burn-out（オーバーレイ）。
4.3 オーバーレイ効果は同期（await）、非オーバーレイは非同期でよい（scene-effects.js が判断）。
4.4 Goto入力欄は初期空、現在ページはplaceholder表示。Enter送信可。
4.5 背景はCSSでは決めない。scene.base をJSが #bgColor と body に直塗り（veilはCSS）。
4.6 scenes.jsonのみを読み込む。インラインJSON使用不可（設計意図：量産時の差替）。
4.7 TTSは初回ユーザー操作でアンロックが必要（ブラウザ規制）。
	5.	debug_config.js（新規：コード側ゲーティング）
5.1 用途: デバッグパネルのセクション／ボタンをコードからのみON/OFF。
5.2 完全体ブロック（新規作成：js/debug_config.js）

/*!
Project: shorts-player-kit
File:    js/debug_config.js
Role:    Debug Panel Config (コード側の機能ゲーティング)
Depends: debug_panel.js（本ファイルより後に読み込む）
*/
window.__dbgConfig = {
  collapsedDefault: true,      // 初期状態: true=畳む / false=展開（LSより優先）
  sections: {
    status:   true,            // 上部ステータス（Page/Version/Playing）
    note:     true,            // Note（AI_Comment）
    controls: true,            // Prev/Next/Play/Stop/Restart
    goto:     true,            // Goto 入力欄＋Goボタン
    ttsFlags: true,            // TTS ON/OFF トグル群
    voices:   true             // 役割別Voice選択群
  },
  buttons: {                   // sections.controls=true のときに有効
    prev:    true,
    next:    true,
    play:    true,
    stop:    true,
    restart: true,
    goto:    true              // Goボタン（Enter送信は常時有効）
  },
  locks: {
    allowTTSFlagEdit:  true,   // falseでTTSトグル群を非表示
    allowVoiceSelect:  true    // falseでVoice選択群を非表示
  }
};

5.3 用途別プリセット（差替用・いずれか1つを上ブロックに貼付）
5.3.1 最小監視

window.__dbgConfig={collapsedDefault:false,sections:{status:true,note:false,controls:false,goto:false,ttsFlags:false,voices:false},buttons:{},locks:{allowTTSFlagEdit:false,allowVoiceSelect:false}};

5.3.2 再生制御のみ

window.__dbgConfig={collapsedDefault:false,sections:{status:true,note:false,controls:true,goto:false,ttsFlags:false,voices:false},buttons:{prev:true,next:true,play:true,stop:true,restart:true,goto:false},locks:{allowTTSFlagEdit:false,allowVoiceSelect:false}};

5.3.3 音声検証集中

window.__dbgConfig={collapsedDefault:false,sections:{status:true,note:true,controls:false,goto:false,ttsFlags:true,voices:true},buttons:{},locks:{allowTTSFlagEdit:true,allowVoiceSelect:true}};

	6.	debug_panel.js（ゲーティング対応版の要点）
6.1 初期空のGoto：value="" 固定、placeholder=現在ページ。成功後もvalueを空に戻す。
6.2 UI→状態変更はしない：__player APIのみを呼び出す（外部状態は汚染しない）。
6.3 折り畳み既定：collapsedDefault を優先。未指定時は localStorage を尊重。
	7.	scene-effects.js（APIと既定実装）
7.1 公開API: register(name, fn) / run(name, el, opts) / isOverlay(name) / list() / has(name)。
7.2 既定エフェクト
7.2.1 light-in, fade-in（同義）, slide-up, zoom-in（非オーバーレイ：非同期再生）
7.2.2 flame-out（別名 burn-out：オーバーレイ：await で締め）
7.3 呼び出し例（自動適用）

if (window.__effects){
  const sceneEl = content.firstElementChild || content;
  const name = (scene && scene.effect) ? scene.effect : 'light-in';
  try { window.__effects.run(name, sceneEl, scene); } catch(e) {}
}

7.4 閉幕の正規形（scenes.json 末尾）

{ "page":"14", "version":"B", "title_key":"【エピローグ】", "title":"……", "base":"#0b132b", "narr":"……" },
{ "page":"15", "type":"effect", "effect":"flame-out", "effectRole":"closing", "base":"#0b132b" }

	8.	player.core.js（TTS／効果の結線要点）
8.1 TTS中央化：scenes.json 読み込み直後に window.__ttsUtils.setup(videoMeta.tts || {}) を一行結線。
8.2 Page1扱い：index===0 はPlayボタンのみ表示。
8.3 演出：renderScene() で scene.base を #bgColor & body に直塗りし、version-(A|B|T) でベール切替。
8.4 TTS無音時の原因切分け
8.4.1 ブラウザの自動再生規制 → 初回クリックで解錠。
8.4.2 __ttsFlags が false の役割 → 該当読み上げスキップ。
8.4.3 narr が空／絵文字のみ → 正規化で空扱い。
	9.	scenes.json の指定（要点と最小例）
9.1 スキーマ要点
9.1.1 version: A|B|T。type:"effect" のときは uiVersion があれば尊重、なければ T。
9.1.2 base: #rrggbb。未指定時フォールバックは A:#f9f9f7 / B,T:#1c1c1e。
9.1.3 effect: "light-in"|"slide-up"|"zoom-in"|"flame-out" 等。effectRole は "opening"|"transition"|"closing"。
9.2 最小例（Copy&Paste）

{
  "videoMeta": {
    "bannerText": "天地創造の第一日",
    "tts": { "lang": "ja-JP", "voicePreferences": ["Kyoko","Otoya"], "rate": 1.2 }
  },
  "scenes": [
    { "page":"1", "type":"title", "title":"プロローグ", "effect":"light-in", "base":"#fef08a" },
    { "page":"2", "type":"text",  "title":"光があるように", "effect":"slide-up", "base":"#f59e0b" }
  ]
}

	10.	トラブルシューティング（頻出例）
10.1 SyntaxError: Unexpected EOF → IIFE末尾 })(); 欠落。末尾を目視。
10.2 エフェクトが動かない → OSの簡易モーション（prefers-reduced-motion: reduce）で即スキップされる仕様。
10.3 TTSが出ない → 初回クリック未実行／__ttsFlags OFF／narr 実質空（絵文字・約物のみ）。
10.4 Playボタンが全ページに出る → renderScene() の「index===0 のみ表示」ロジックを確認。
10.5 バーンアウトが本文より先に走る → 閉幕順序を「B→flame-out」に正規化。
	11.	Copy&Paste運用規範（完全体アンカー）
11.1 3Step厳守
11.1.1 1) ファイル名を宣言 → 2) 操作種別（replace-block / insert-after / replace-file） → 3) 検索アンカー（直前行/署名行/直後行）。
11.2 単一一致でなければ中止
11.2.1 ヒットが0または2以上なら中止し、アンカーを再定義。
11.3 差分提示
11.3.1 回答では前後1行を含む完全体ブロックを提示（本README準拠）。
	12.	変更履歴（要点）
12.1 2025-08-24
12.1.1 debug_config.js を新規追加。コード側ゲーティングを導入。
12.1.2 debug_panel.js を初期空のGoto／placeholder現在ページ化。
12.1.3 閉幕順序を README 規約へ明文化（Epilogue→flame-out）。
12.1.4 index.html の読込順を確定（scene-effects → player.core → debug_config → debug_panel）。
	13.	NS-Core+Joy（運用テンプレ）
13.1 Propose: <今回の単一行動>
13.2 Justify: VOI ≥ Cost を一文で。
13.3 Min-Execute: 1) <設計> 2) <取得> 3) <適用>
13.4 Verify: 期待=<KPI> / 実測=<値>（合格｜要修正）
13.5 Record: 変更点=<Δ> / 教訓=<再利用可能な一句>
13.6 Joy: <7〜20文字の短評 / 絵文字1つまで>