# shorts-player-kit / js README (2025-08-30)

この文書は `js/` 配下の**最新実装規範**です。iOS（Textastic × Working Copy）運用で迷わないよう、
読み込み順・UIゲーティング・TTS規範・ローカル検証までを一か所に集約します。

---

## 1) 目的 / グラウンドルール

- **役割別レートのみ**で運用（基準レート UI は既定で非表示）。
- **クランプ**は **0.5–2.0**、**既定=1.4**。UIで即時反映・永続化（LocalStorage）を保証。
- `Page 1` は **Play 専用**。Opening / Transition / Closing は **純エフェクト**（テキスト無し）。
- **iOS前提**：ファイル直読み（`file://`）では `fetch('./scenes.json')` が失敗しやすい。**http 経由**で動かす。

---

## 2) モジュール一覧（現行ファイル）

- **`scene-effects.js`**  
  軽量エフェクトのレジストリ。`register / run / list / has` を提供。  
  既定: `light-in, fade-in, slide-up, zoom-in, flame-out`（`flame-out` はオーバーレイ＝await）。

- **`tts-voice-utils.js`**  
  Web Speech API の声カタログと **レート・エンジン**。  
  - API（主要）:
    - `setup(meta)` … `videoMeta.tts` を適用（JA-only フィルタ等）
    - `getCatalog({jaOnly})` / `pick(role)`
    - `setRate(r)`（互換ブリッジ）
    - `setRateRole(map)` / `getRateRole()` … 役割別の**絶対レート**を持つ
    - `getRateForRole(base, role)` … **0.5–2.0 clamp**。`perRoleAbs` モードでは `base` を無視して絶対値（LS/既定）を返す
  - 既定：`{ tag:1.4, titleKey:1.4, title:1.4, narr:1.4 }` を LS 未設定時に使用

- **`player.core.js`**  
  再生中枢。シーン描画・エフェクト実行・TTS読み上げ・`__player` API を提供。  
  **速度参照は一本化**：内部ヘルパ `rateFor(role)` が `__ttsUtils.getRateForRole(1.0, role)` を使用。  
  旧 `roleRate()` は**廃止**。ページ遷移ウェイトも `rateFor('narr')` に統一。

- **`debug_config.js`**  
  コード側の UI ゲーティング。**既定は基準レート非表示**・**役割別のみ**。  
  代表設定（例）:
  ```js
  window.__dbgConfig = {
    collapsedDefault: true,
    sections: {
      status: true, note: false, controls: true, goto: true,
      ttsFlags: true, voices: true,
      baseRate: false        // ← 「Rate:」行（基準レート）は既定で非表示
    },
    locks: { allowTTSFlagEdit: true, allowVoiceSelect: true },
    // 役割別レートの帯域（UI）
    rolesRate: { min: 0.5, max: 2.0, step: 0.1, defaultAbs: 1.4 },
    // 速度規範モード
    rateMode: 'perRoleAbs'
  };

	•	debug_panel.js
底部に固定されるデバッグ UI。モバイル最適化（全 input/select 高さ 34px）。
	•	Role Rate ×（Tag / TitleKey / Title / Narr）スライダ＋数値入力。
	•	Voices 行は チェックボックス＋セレクトを一列に統合（例：Voice: [✓] Tag <select>  [✓] TitleKey <select> …）。
	•	LocalStorage
	•	dbg.panel.collapsed.v2（折り畳み状態）
	•	dbg.tts.role.tag|titleKey|title|narr（役割別レート）
	•	dbg.tts.rate（互換キー / 基準レートUIを使う場合のみ）
	•	global-zoom-guard.js（任意）
ズーム/セーフエリアの挙動ガード。必要に応じて使用。

⸻

3) 読み込み順（厳守）

<!-- 1. エフェクト（非依存） -->
<script src="./js/scene-effects.js" defer></script>
<!-- 2. TTSユーティリティ（プレイヤより前） -->
<script src="./js/tts-voice-utils.js" defer></script>
<!-- 3. プレイヤ中枢 -->
<script src="./js/player.core.js" defer></script>
<!-- 4. デバッグ設定（UI本体より前） -->
<script src="./js/debug_config.js" defer></script>
<!-- 5. デバッグUI本体 -->
<script src="./js/debug_panel.js" defer></script>
<!-- 6. 追加の環境ガード（必要なときだけ） -->
<script src="./js/global-zoom-guard.js" defer></script>

理由: player.core.js が __ttsUtils を呼ぶため、tts-voice-utils.js を必ず先に読む。
UI は __dbgConfig に依存するため debug_config.js → debug_panel.js の順。

⸻

4) デバッグ UI 仕様（要点）
	•	Role Rate ×
	•	範囲: 0.5–2.0、step=0.1、既定=1.4
	•	双方向バインド：スライダ ↔ 数値入力
	•	変更は即時 __ttsUtils.setRateRole(map) に反映し、LSへ永続化
	•	TTS フラグ: Tag / TitleKey / Title / Narr を個別に ON/OFF（__ttsFlags）
	•	Voices: 各役割の声を安定 ID（voiceURI > lang|name > name）で選択。Auto は pick(role) に委任
	•	Rate 行（基準レート）: sections.baseRate=false なら非表示（推奨）。必要時のみ一時的に true。

⸻

5) TTS 速度規範
	•	唯一の規範: 役割別絶対レート 0.5–2.0（既定=1.4）。
	•	player.core.js の待機時間・発話速度・UIが常に同じ規範で動く。
	•	速度の計算は __ttsUtils.getRateForRole(1.0, role) に一元化（プレイヤ側で独自クランプ禁止）。

⸻

6) iOS ローカル検証（Safari で http 再生）

6.1 a-Shell で簡易サーバ
	1.	プロジェクト一式を a-Shell 側にコピー（Working Copy から「Share ▶︎ Save to Files ▶︎ a-Shell」など）。
	2.	a-Shell で以下を実行：

cd ~/Documents/shorts-player-kit
python3 -m http.server 8080


	3.	Safari で http://127.0.0.1:8080/index.html を開く（file:// は使用しない）。

TIP: Textastic で編集 → 保存 → Safari でリロード、のループで即確認できます。

⸻

7) Working Copy（最新版 UI）での運用
	•	コミット: 右上「Status」→ 変更内容を確認 → Commit
メッセージ例:
	•	feat(debug-panel): unify Voice row & role-rate defaults
	•	docs(js): rewrite README for perRoleAbs 0.5–2.0
	•	Apply Patch: リポ画面右上 … → Apply Patch → Unified Diff を貼付 → Apply → Commit
	•	ブランチ: main 安定／作業は feat/xxx, fix/xxx。完了後 Merge into main。

⸻

8) トラブルシュート
	•	Rate 行が出る: debug_config.js の sections.baseRate を false に。読み込み順も再確認。
	•	速度が変わらない:
	1.	LS の dbg.tts.role.* をクリア（または Reset ボタン）、
	2.	tts-voice-utils.js が読み込まれているか確認。
	•	音声が出ない: 初回クリック未実行／TTSフラグ OFF／narr 実質空（絵文字のみ）／iOSの音量 or サイレント。

⸻

9) 付録：想定 LocalStorage キー
	•	dbg.tts.role.tag / dbg.tts.role.titleKey / dbg.tts.role.title / dbg.tts.role.narr
	•	dbg.panel.collapsed.v2
	•	dbg.tts.rate（互換・基準レート UI 有効時のみ）

⸻

10) 変更履歴（主要 Δ）
	•	2025-08-30:
	•	速度規範を perRoleAbs (0.5–2.0, default 1.4) に統一
	•	player.core.js を rateFor(role) に一本化（roleRate() 廃止）
	•	Debug Panel: Voice 行の統合、Role Rate × の UI 仕上げ
	•	本 README を全面更新（最新版 Working Copy / iOS 検証手順）

---

## Working Copy で README を更新・コミットする手順
1) Textastic で `js/README.md` を開き、**上の全文で置き換え**→保存。  
2) Working Copy でリポを開き、右上 **Status** → 変更一覧に `js/README.md` が出ていることを確認。  
3) **COMMIT** をタップし、メッセージ例：`docs(js): rewrite README for perRoleAbs 0.5–2.0` → **Commit**。  
4) 必要なら右上 `…` → **Push**（GitHub 等のリモートを設定済みの場合）。

何かズレがあれば、スクショか該当ファイルの冒頭数十行を貼ってください。すぐに合わせ込みます。